<!DOCTYPE html>
<!--Elevation Finder 0.4
	March 24, 2025
	0.1: First version
	0.2: Adds "use current location" button
	0.3: Add nearest weather forecast
	0.4: Add nearest climate data and some input validation
-->

<html lang="en">
	<head>
		<style>
			body {
			  font-size: 0.75 rem;
			  margin-left:1rem;
			  margin-right:1rem;
			}
			
			button {
				margin-left:1rem;
				width:25%;
				min-width: 5rem;
				max-width: 15rem;
			}
			
			input {
				width:65%;
				min-width: 17rem;
				max-width: 50rem;
			}
			
			.inputblock {
				display:flex;
				align-items:center;
			}
		</style>
	</head>
	
	<title>Elevation Finder 0.4</title>
	
	<body>
		<br/>
		Enter a comma-separated latitude and longitude in decimal degrees (e.g., pasted coordinates from Google Maps): <br/><br/>
		<div class="inputblock">
			<input type="text" id="latlongstring" step="any" placeholder="e.g., 49.5, -120.5" oninput="getElevationData()">
			
			<button id="find-me">Use my current location</button><br />
		</div>
		<div id="statusContainer">
			<br/>
			<div id="status"></div>
		</div>
		<br/>
		<div id="dataContainer" style="display:none">
			<div id="latlongdisplay"></div>
			<br/>
			<div id="elevationData"></div>
			<br/>
			<div id="elevationURL"></div>
			<br/>
			<div id="citation"></div>
			<br/>
			<div id="weatherData">
				<hr/>
				<a id="weatherLink">Nearest Weather Forecast</a><br/>
				<a id="climateLink">Historical climate data</a><br/>
			</div>
			<br/>
		</div>

		<script>
		
			const status = document.querySelector("#status");
			
			function getElevationData() {
			
				// Parse the comma-separated lat/long into its parts, and trim whitespace
				const latlong = document.getElementById("latlongstring").value.split(",");			
				
				// Check if the input is valid (i.e., there are exactly two values after splitting by comma)
				if (latlong.length !== 2 || !latlong[0].trim() || !latlong[1].trim()) {
					// Silently return because the user might still be typing
					return;
				}
				
				const lat = latlong[0].trim();
				const lon = latlong[1].trim();
				
				// Check if latitude and longitude are valid numbers
				if (isNaN(lat) || isNaN(lon)) {
					// Silently return because the user might still be typing
					return;
				}
				
				// Get the date and date parts
				const date = new Date();
				const currentyear = date.getFullYear();
				const currentmonth = date.toLocaleString('default', { month: 'long' });
				const currentmonth_short = date.getMonth() + 1;
				const dayOfMonth = date.getDate();
				
				// Build the elevation, weather, and climate URLs with the latitude and longitude from the inputs
				const elevationURL = `https://geogratis.gc.ca/services/elevation/cdem/altitude?lat=${lat}&lon=${lon}`;
				const weatherURL = `https://weather.gc.ca/en/location/index.html?coords=${lat},${lon}`;
				const climateURL = `https://climate.weather.gc.ca/historical_data/search_historic_data_stations_e.html?searchType=stnProx&timeframe=1&txtRadius=25&selCity=&selPark=&txtCentralLatDeg=&txtCentralLatMin=&txtCentralLatSec=&txtCentralLongDeg=&txtCentralLongMin=&txtCentralLongSec=&optProxType=decimal&txtLatDecDeg=${lat}&txtLongDecDeg=${lon}&optLimit=yearRange&StartYear=1840&EndYear=${currentyear}&Year=${currentyear}&Month=${currentmonth_short}&Day=${dayOfMonth}&selRowPerPage=25`;
				
				// Fetch data from the API
				fetch(elevationURL)
					.then(response => response.json())  // Parse the JSON response
					.then(data => {
						// Check if the response contains the expected 'altitude' field
						if (data && data.altitude) {
							// Display the parsed altitude data
							document.getElementById("statusContainer").style.display = "none";
							document.getElementById("dataContainer").style.display = "inline";
							
							document.getElementById("elevationData").innerHTML = `<strong>Elevation: ${data.altitude} meters</strong>`;
							document.getElementById("elevationURL").innerHTML = `Link for data QA/QC: <a href=${elevationURL}>${elevationURL}</a>`;
							document.getElementById("citation").innerHTML = `Suggested citation: Natural Resources Canada (NRC). ${currentyear}. Canadian Digital Elevation Model (via Elevation API). Available at: <a href="https://natural-resources.canada.ca/science-data/data-analysis/geospatial-data-portals-tools-services/elevation-api">https://natural-resources.canada.ca/science-data/data-analysis/geospatial-data-portals-tools-services/elevation-api</a>. Accessed ${currentmonth} ${currentyear}.`;
							document.getElementById("latlongdisplay").innerHTML = `Location: ${lat}, ${lon}`;
							document.getElementById("weatherLink").setAttribute("href", `${weatherURL}`);
							document.getElementById("climateLink").setAttribute("href", `${climateURL}`);
						} else {
							document.getElementById("statusContainer").style.display = "inline";
							status.textContent = "No elevation data available.";
							document.getElementById("dataContainer").style.display = "none";
						}
					})
					.catch(error => {
						console.error("Error fetching data:", error);
						status.textContent = "Error fetching data.";
					});
			}
			
			function geoFindMe() {

			  function success(position) {
				const latitude = position.coords.latitude;
				const longitude = position.coords.longitude;

				document.getElementById("statusContainer").style.display = "none";
				document.getElementById("latlongstring").value = `${latitude},${longitude}`;
				document.getElementById("latlongdisplay").innerHTML = `Location: ${latitude}, ${longitude}`;
				
				getElevationData();
			  }

			  function error() {
			  document.getElementById("statusContainer").style.display = "inline";
				status.textContent = "Unable to retrieve your location";
				document.getElementById("dataContainer").style.display = "none";
			  }

			  if (!navigator.geolocation) {
				document.getElementById("statusContainer").style.display = "inline";
				status.textContent = "Geolocation is not supported by your browser";
				document.getElementById("dataContainer").style.display = "none";
			  } else {
				document.getElementById("statusContainer").style.display = "inline";
				status.textContent = "Locatingâ€¦";
				navigator.geolocation.getCurrentPosition(success, error);
			  }
			}

			document.querySelector("#find-me").addEventListener("click", geoFindMe);

		</script>
	</body>
</html>